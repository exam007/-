<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แบบทดสอบ ภาค ก. ท้องถิ่น กฎหมาย 200 ข้อ</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ... (CSS เดิมของคุณ) ... */
    </style>
</head>
<body>
    <div class="container mx-auto p-4 max-w-4xl min-h-screen flex flex-col justify-center items-center">
        <div id="loginBox" class="bg-card p-8 rounded-lg shadow-neumorphic w-full max-w-md text-center">
            <h2 class="text-2xl font-bold text-text-primary mb-6">เข้าสู่ระบบเพื่อทำแบบทดสอบ</h2>
            <div id="loggedInUserDisplay" class="mb-4 hidden">
                <p class="text-text-secondary">ล็อกอินในฐานะ: <span id="userEmailDisplay" class="font-semibold text-text-primary"></span></p>
                <button id="startQuizWithGoogle" class="btn-primary mt-4">เริ่มทำแบบทดสอบ</button>
            </div>
            <div id="customLoginFields">
                <div class="mb-4">
                    <input type="text" id="username" placeholder="ชื่อผู้ใช้งาน" class="input-field">
                </div>
                <div class="mb-6">
                    <input type="password" id="userCode" placeholder="รหัสผ่าน" class="input-field">
                </div>
                <button id="loginButton" class="btn-primary">เข้าสู่ระบบ</button>
            </div>
            <p id="loginMessage" class="text-red-500 mt-4 hidden"></p>
        </div>

        <div id="quizBox" class="bg-card p-8 rounded-lg shadow-neumorphic w-full max-w-4xl text-left hidden">
            <div id="quizHeader" class="mb-4 flex justify-between items-center">
                <span id="questionCount" class="text-text-secondary text-lg">คำถามที่ 1/200</span>
                <span id="timer" class="text-text-primary text-xl font-semibold">เวลา: 00:00:00</span>
                <button id="closeButton" class="text-text-secondary hover:text-red-500 text-2xl font-bold">&times;</button>
            </div>
            <h3 id="questionText" class="text-text-primary text-xl font-medium mb-6"></h3>
            <div id="optionsContainer" class="space-y-4 mb-8">
                </div>
            <div class="flex justify-between">
                <button id="prevButton" class="btn-secondary">ย้อนกลับ</button>
                <button id="nextButton" class="btn-primary">ถัดไป</button>
            </div>
        </div>

        <div id="resultBox" class="bg-card p-8 rounded-lg shadow-neumorphic w-full max-w-md text-center hidden">
            <h2 class="text-2xl font-bold text-text-primary mb-6">ผลการทำแบบทดสอบ</h2>
            <p class="text-lg text-text-secondary mb-2">คะแนนของคุณ: <span id="finalScore" class="font-semibold text-text-primary"></span> / <span id="totalQuestionsResult" class="font-semibold text-text-primary"></span></p>
            <p class="text-lg text-text-secondary mb-4">เวลาที่ใช้: <span id="finalTimeSpent" class="font-semibold text-text-primary"></span></p>
            <button id="reviewButton" class="btn-secondary mr-2">ทบทวนคำตอบ</button>
            <button id="retakeButton" class="btn-primary">ทำแบบทดสอบใหม่</button>
        </div>

        <div id="reviewBox" class="bg-card p-8 rounded-lg shadow-neumorphic w-full max-w-4xl text-left hidden">
            <h2 class="text-2xl font-bold text-text-primary mb-6">ทบทวนคำตอบ</h2>
            <div id="reviewQuestionsContainer" class="space-y-6">
                </div>
            <button id="backToResultsButton" class="btn-secondary mt-6">กลับไปยังผลลัพธ์</button>
        </div>

        <div id="confirmationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-8 rounded-lg shadow-lg text-center">
                <h3 class="text-xl font-bold mb-4">ยืนยันการส่งคำตอบ</h3>
                <p class="mb-6">คุณแน่ใจหรือไม่ว่าต้องการส่งคำตอบและออกจากแบบทดสอบ?</p>
                <button id="confirmSubmit" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 mr-2">ส่งคำตอบ</button>
                <button id="cancelSubmit" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">ยกเลิก</button>
            </div>
        </div>
    </div>

    <script>
        const SPREADSHEET_ID = '1AK-wX8QkR_sYgmpD8wYJ0CPF4MIqj_sP576zfG2uHSQ'; // เปลี่ยนเป็น Spreadsheet ID ของคุณ
        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let timerInterval;
        let startTime;
        let loggedInUserEmail = ''; // เก็บอีเมลผู้ใช้ที่ล็อกอินด้วย Google

        const loginBox = document.getElementById('loginBox');
        const loggedInUserDisplay = document.getElementById('loggedInUserDisplay');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const startQuizWithGoogleButton = document.getElementById('startQuizWithGoogle');
        const customLoginFields = document.getElementById('customLoginFields');
        const usernameInput = document.getElementById('username');
        const userCodeInput = document.getElementById('userCode');
        const loginButton = document.getElementById('loginButton');
        const loginMessage = document.getElementById('loginMessage');
        const quizBox = document.getElementById('quizBox');
        const questionCount = document.getElementById('questionCount');
        const timerElement = document.getElementById('timer');
        const questionText = document.getElementById('questionText');
        const optionsContainer = document.getElementById('optionsContainer');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const resultBox = document.getElementById('resultBox');
        const finalScore = document.getElementById('finalScore');
        const totalQuestionsResult = document.getElementById('totalQuestionsResult');
        const finalTimeSpent = document.getElementById('finalTimeSpent');
        const reviewButton = document.getElementById('reviewButton');
        const retakeButton = document.getElementById('retakeButton');
        const reviewBox = document.getElementById('reviewBox');
        const reviewQuestionsContainer = document.getElementById('reviewQuestionsContainer');
        const backToResultsButton = document.getElementById('backToResultsButton');
        const closeButton = document.getElementById('closeButton');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmSubmitButton = document.getElementById('confirmSubmit');
        const cancelSubmitButton = document.getElementById('cancelSubmit');

        // Helper function to switch views
        function switchView(viewId) {
            loginBox.classList.add('hidden');
            quizBox.classList.add('hidden');
            resultBox.classList.add('hidden');
            reviewBox.classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
        }

        // Function to show confirmation modal
        function showConfirmationModal() {
            confirmationModal.classList.remove('hidden');
        }

        // Function to hide confirmation modal
        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
        }

        // Function to handle early quiz submission
        function submitQuizEarly() {
            endQuiz(true); // Call endQuiz, indicating it's an early submission
        }

        // Event listener for close button (X)
        closeButton.addEventListener('click', showConfirmationModal);
        // Event listener for "Submit Answer" button in modal
        confirmSubmitButton.addEventListener('click', () => {
            hideConfirmationModal();
            submitQuizEarly();
        });
        // Event listener for "Cancel" button in modal
        cancelSubmitButton.addEventListener('click', hideConfirmationModal);

        // Function to start the quiz
        async function startQuiz(userNameForQuiz, userCodeForQuiz) {
            // ล้างข้อมูลเก่า
            userAnswers = Array(questions.length).fill(null);
            currentQuestionIndex = 0;
            updateQuestionDisplay();
            startTimer();
            switchView('quizBox');
        }

        // ... (loadQuestions, updateQuestionDisplay, nextQuestion, prevQuestion, selectOption, startTimer, stopTimer, formatTime functions remain the same) ...

        function loadQuestions() {
            google.script.run
                .withSuccessHandler(function(data) {
                    if (data.success) {
                        questions = data.questions;
                        // Initialize userAnswers with null for each question
                        userAnswers = Array(questions.length).fill(null);
                        updateQuestionDisplay();
                        // Don't start quiz here, wait for login
                    } else {
                        console.error('Failed to load questions:', data.message);
                        alert('เกิดข้อผิดพลาดในการโหลดข้อสอบ: ' + data.message);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading questions:', error.message);
                    alert('เกิดข้อผิดพลาดในการเชื่อมต่อเพื่อโหลดข้อสอบ: ' + error.message);
                })
                .getQuestions();
        }

        function updateQuestionDisplay() {
            if (questions.length === 0) {
                questionText.textContent = 'ไม่พบคำถาม';
                optionsContainer.innerHTML = '';
                prevButton.disabled = true;
                nextButton.disabled = true;
                return;
            }

            const currentQuestion = questions[currentQuestionIndex];
            questionCount.textContent = `คำถามที่ ${currentQuestionIndex + 1}/${questions.length}`;
            questionText.textContent = currentQuestion.question;
            optionsContainer.innerHTML = '';

            currentQuestion.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.classList.add('option-item');
                optionElement.innerHTML = `
                    <input type="radio" id="option${index}" name="question${currentQuestionIndex}" value="${option}" class="hidden">
                    <label for="option${index}" class="option-label p-4 rounded-lg cursor-pointer block">
                        ${String.fromCharCode(65 + index)}. ${option}
                    </label>
                `;
                optionsContainer.appendChild(optionElement);

                // Check if this option was previously selected
                if (userAnswers[currentQuestionIndex] === option) {
                    optionElement.querySelector('input').checked = true;
                    optionElement.querySelector('label').classList.add('selected');
                }

                optionElement.querySelector('input').addEventListener('change', () => {
                    selectOption(currentQuestionIndex, option);
                    // Remove 'selected' class from all labels for this question
                    optionsContainer.querySelectorAll('.option-label').forEach(label => {
                        label.classList.remove('selected');
                    });
                    // Add 'selected' class to the currently selected label
                    optionElement.querySelector('label').classList.add('selected');
                });
            });

            prevButton.disabled = currentQuestionIndex === 0;
            nextButton.textContent = currentQuestionIndex === questions.length - 1 ? 'ส่งคำตอบ' : 'ถัดไป';
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                updateQuestionDisplay();
            } else {
                showConfirmationModal(); // Show modal before submitting
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                updateQuestionDisplay();
            }
        }

        function selectOption(questionIndex, selectedOption) {
            userAnswers[questionIndex] = selectedOption;
        }

        function startTimer() {
            startTime = new Date().getTime();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function formatTime(seconds) {
            const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const s = String(seconds % 60).padStart(2, '0');
            return `${h}:${m}:${s}`;
        }


        // Function to end the quiz and calculate score
        async function endQuiz() {
            stopTimer();
            let score = 0;
            let correctAnswersCount = 0;
            const timeSpent = Math.floor((new Date().getTime() - startTime) / 1000);

            questions.forEach((q, index) => {
                if (userAnswers[index] === q.correctAnswer) {
                    score += 1;
                    correctAnswersCount += 1;
                }
            });

            finalScore.textContent = score;
            totalQuestionsResult.textContent = questions.length;
            finalTimeSpent.textContent = formatTime(timeSpent);

            // Fetch IP Address
            let ipAddress = '';
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                ipAddress = data.ip;
            } catch (error) {
                console.error('Failed to get IP address:', error);
            }

            // Prepare data for saving
            const resultData = {
                userName: loggedInUserEmail || usernameInput.value, // ใช้ email ถ้าล็อกอินด้วย Google, ไม่เช่นนั้นใช้ username เดิม
                userCode: '', // ล้าง userCode เพราะไม่จำเป็นเมื่อล็อกอินด้วย Gmail
                score: score,
                correctAnswers: correctAnswersCount,
                totalQuestions: questions.length,
                answers: userAnswers,
                timeSpent: timeSpent,
                ipAddress: ipAddress
            };

            // Save result to Google Sheet
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        console.log('บันทึกผลสอบสำเร็จ:', response.message);
                    } else {
                        console.error('เกิดข้อผิดพลาดในการบันทึกผลสอบ:', response.message);
                        alert('เกิดข้อผิดพลาดในการบันทึกผลสอบ: ' + response.message);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error saving result:', error.message);
                    alert('เกิดข้อผิดพลาดในการเชื่อมต่อเพื่อบันทึกผลสอบ: ' + error.message);
                })
                .saveResult(resultData);

            switchView('resultBox');
        }

        function reviewAnswers() {
            reviewQuestionsContainer.innerHTML = '';
            questions.forEach((q, index) => {
                const reviewItem = document.createElement('div');
                reviewItem.classList.add('review-item', 'p-4', 'rounded-lg', 'border', 'mb-4');

                const isCorrect = userAnswers[index] === q.correctAnswer;
                reviewItem.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');

                let feedbackHtml = '';
                if (!isCorrect) {
                    feedbackHtml = `<p class="text-red-600 mt-2">คำตอบของคุณ: ${userAnswers[index] || 'ไม่ได้เลือก'}</p>`;
                }
                feedbackHtml += `<p class="text-green-600 mt-2">คำตอบที่ถูกต้อง: ${q.correctAnswer}</p>`;

                reviewItem.innerHTML = `
                    <p class="font-semibold text-lg text-text-primary mb-2">คำถามที่ ${index + 1}: ${q.question}</p>
                    <ul class="list-disc ml-5">
                        ${q.options.map((option, optIndex) => `
                            <li class="${option === q.correctAnswer ? 'text-green-600' : (userAnswers[index] === option && !isCorrect ? 'text-red-600' : 'text-text-secondary')}">
                                ${String.fromCharCode(65 + optIndex)}. ${option}
                            </li>
                        `).join('')}
                    </ul>
                    ${feedbackHtml}
                `;
                reviewQuestionsContainer.appendChild(reviewItem);
            });
            switchView('reviewBox');
        }

        function resetQuiz() {
            stopTimer();
            questions = [];
            currentQuestionIndex = 0;
            userAnswers = [];
            usernameInput.value = '';
            userCodeInput.value = '';
            loginMessage.style.display = 'none';
            loginMessage.textContent = '';
            
            // กลับไปหน้าล็อกอิน
            switchView('loginBox');
            // โหลดคำถามใหม่เมื่อกลับไปหน้าล็อกอิน (เพื่อให้แน่ใจว่าข้อมูลพร้อม)
            loadQuestions(); 
        }

        // Event Listeners
        loginButton.addEventListener('click', async () => {
            const username = usernameInput.value.trim();
            const userCode = userCodeInput.value.trim();

            if (!username || !userCode) {
                loginMessage.textContent = 'กรุณาใส่ชื่อผู้ใช้งานและรหัสผ่าน';
                loginMessage.style.display = 'block';
                return;
            }

            loginMessage.style.display = 'none';
            loginMessage.textContent = '';

            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        loggedInUserEmail = username; // ในกรณีใช้การล็อกอินแบบเดิม ให้ถือว่า username คือ email
                        startQuiz(username, userCode);
                    } else {
                        loginMessage.textContent = response.message;
                        loginMessage.style.display = 'block';
                    }
                })
                .withFailureHandler(function(error) {
                    loginMessage.textContent = 'เกิดข้อผิดพลาดในการตรวจสอบผู้ใช้งาน: ' + error.message;
                    loginMessage.style.display = 'block';
                })
                .checkUser(username, userCode);
        });

        startQuizWithGoogleButton.addEventListener('click', () => {
            startQuiz(loggedInUserEmail, ''); // เริ่มต้นด้วยอีเมลที่ล็อกอินด้วย Google
        });

        nextButton.addEventListener('click', nextQuestion);
        prevButton.addEventListener('click', prevQuestion);
        reviewButton.addEventListener('click', reviewAnswers);
        retakeButton.addEventListener('click', resetQuiz);
        backToResultsButton.addEventListener('click', () => switchView('resultBox'));

        // Event Listener: เริ่มต้นการทำงานเมื่อหน้าเว็บโหลดเสร็จ
        document.addEventListener('DOMContentLoaded', function() {
            // ตรวจสอบว่าผู้ใช้ล็อกอินด้วย Google แล้วหรือไม่
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.email) {
                        loggedInUserEmail = response.email;
                        userEmailDisplay.textContent = loggedInUserEmail;
                        loggedInUserDisplay.classList.remove('hidden');
                        customLoginFields.classList.add('hidden');
                        loginButton.classList.add('hidden'); // ซ่อนปุ่มล็อกอินแบบเดิม
                    } else {
                        // ถ้ายังไม่ได้ล็อกอินด้วย Google ให้แสดงหน้าล็อกอินปกติ
                        loggedInUserDisplay.classList.add('hidden');
                        customLoginFields.classList.remove('hidden');
                        loginButton.classList.remove('hidden');
                    }
                    loadQuestions(); // โหลดคำถามเสมอเมื่อ DOM โหลดเสร็จ
                })
                .withFailureHandler(function(error) {
                    console.error('Error checking logged in user:', error.message);
                    // หากเกิดข้อผิดพลาดในการตรวจสอบผู้ใช้ Google ให้แสดงหน้าล็อกอินปกติ
                    loggedInUserDisplay.classList.add('hidden');
                    customLoginFields.classList.remove('hidden');
                    loginButton.classList.remove('hidden');
                    loadQuestions(); // โหลดคำถามในกรณีที่เกิดข้อผิดพลาด
                })
                .getLoggedInUser(); // เรียกฟังก์ชันใน GS เพื่อตรวจสอบอีเมลผู้ใช้ที่ล็อกอินอยู่

            // เริ่มต้นโดยการแสดงหน้าล็อกอินเท่านั้น
            switchView('loginBox');
        });
    </script>
</body>
</html>
